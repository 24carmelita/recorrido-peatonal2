<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Recorrido en Coche - Campeche</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
margin: 0;
font-family: 'Segoe UI', sans-serif;
background-color: #f8f8f8;
}
header {
background-color: #702c37;
color: #b38b28;
padding: 20px;
text-align: center;
position: relative;
}
.logo {
position: absolute;
top: 35px;
left: 10px;
height: 50px;
width: auto;
transition: all 0.3s ease;
}
@media screen and (max-width: 768px) {
.logo {
height: 40px;
top: 5px;
left: 5px;
}
header h1 {
font-size: 1.5em;
padding: 10px 0;
}
}
.container {
display: flex;
position: relative;
height: 500px;
width: 90%;
max-width: 1200px;
margin: 20px auto;
border-radius: 15px;
box-shadow: 0 0 15px #00000022;
overflow: hidden;
}
#map {
flex: 1;
height: 100%;
z-index: 1;
}
/* Panel lateral */
#sidebar {
position: absolute;
top: 0;
right: -400px;
width: 400px;
height: 100%;
background: white;
box-shadow: -4px 0 20px rgba(0,0,0,0.15);
transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
z-index: 1000;
overflow-y: auto;
border-left: 3px solid #8B0000;
}
#sidebar.active {
right: 0;
}
.sidebar-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
padding: 20px;
border-bottom: 2px solid #e5e7eb;
background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
position: sticky;
top: 0;
z-index: 10;
}
.header-content {
flex: 1;
}
.sidebar-header h2 {
color: #8B0000;
font-size: 1.4rem;
margin: 0 0 8px 0;
font-weight: 700;
line-height: 1.3;
}
.distance-info {
display: flex;
align-items: center;
gap: 8px;
margin-top: 8px;
}
.distance-label {
font-size: 14px;
color: #6b7280;
font-weight: 500;
}
.distance-value {
font-size: 14px;
color: #059669;
font-weight: 600;
background: #d1fae5;
padding: 2px 8px;
border-radius: 12px;
}
.close-btn {
background: #8B0000;
color: white;
border: none;
padding: 8px 12px;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: 600;
transition: all 0.3s ease;
margin-left: 15px;
}
.close-btn:hover {
background: #a30000;
}
/* Carrusel de im√°genes */
.image-carousel {
padding: 20px;
}
.carousel-container {
position: relative;
background: #f8fafc;
border-radius: 12px;
overflow: hidden;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
border: 1px solid #e5e7eb;
}
.carousel-images {
position: relative;
height: 250px;
overflow: hidden;
}
.carousel-image {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
object-fit: cover;
opacity: 0;
transition: opacity 0.6s ease-in-out;
border-radius: 12px 12px 0 0;
}
.carousel-image.active {
opacity: 1;
}
.carousel-controls {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px;
background: white;
}
.carousel-btn {
background: #8B0000;
color: white;
border: none;
padding: 8px 12px;
border-radius: 8px;
cursor: pointer;
font-size: 12px;
font-weight: 600;
transition: all 0.3s ease;
}
.carousel-btn:hover {
background: #a30000;
}
.carousel-indicators {
display: flex;
gap: 8px;
align-items: center;
}
.indicator {
width: 10px;
height: 10px;
border-radius: 50%;
background: #d1d5db;
cursor: pointer;
transition: all 0.3s ease;
}
.indicator.active {
background: #8B0000;
transform: scale(1.2);
}
.carousel-progress {
height: 3px;
background: #e5e7eb;
position: relative;
overflow: hidden;
}
.progress-bar {
height: 100%;
background: #8B0000;
width: 0%;
transition: none;
}
/* Descripci√≥n del sitio */
.site-description {
padding: 0 20px 20px;
}
.site-description p {
line-height: 1.6;
color: #374151;
margin-bottom: 15px;
text-align: justify;
font-size: 14px;
background: #f9fafb;
padding: 15px;
border-radius: 10px;
border-left: 4px solid #8B0000;
}
.action-buttons {
display: flex;
gap: 10px;
flex-direction: column;
}
.speak-btn, .center-btn, .route-btn {
background: #8B0000;
color: white;
border: none;
padding: 10px 15px;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: 600;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
}

#pauseBtn {
  background: #6b7280; /* gris oscuro */
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  display: none; /* para ocultarlo por defecto */
}

#pauseBtn:hover {
  background: #4b5563;
}

.speak-btn:hover, .center-btn:hover, .route-btn:hover {
background: #a30000;
}
.speak-btn:disabled {
background: #9ca3af;
cursor: not-allowed;
}
/* Bot√≥n especial para crear ruta en sidebar */
.route-btn {
background: linear-gradient(135deg, #059669 0%, #047857 100%);
}
.route-btn:hover {
background: linear-gradient(135deg, #047857 0%, #065f46 100%);
}
#distance,
#description {
text-align: center;
margin-top: 10px;
font-size: 1.2em;
font-weight: bold;
}
#description {
padding: 10px;
margin-bottom: 10px;
}
.btn-red-vino {
background-color: #8B0000;
color: #fff;
border: none;
cursor: pointer;
transition: background 0.3s;
padding: 6px 12px;
border-radius: 8px;
margin: 2px;
}
.btn-red-vino:hover {
background-color: #a30000;
}
/* Bot√≥n cancelar ruta */
.btn-cancel {
background-color: #dc3545;
color: #fff;
border: none;
cursor: pointer;
transition: background 0.3s;
padding: 6px 12px;
border-radius: 8px;
margin: 2px;
}
.btn-cancel:hover {
background-color: #c82333;
}
/* Contenedor de botones de control */
.route-controls {
text-align: center;
margin-top: 10px;
display: flex;
justify-content: center;
gap: 10px;
flex-wrap: wrap;
}
/* Estado de ruta activa */
.route-status {
background: #d1fae5;
color: #065f46;
padding: 8px 15px;
border-radius: 8px;
margin: 10px auto;
display: none;
max-width: 300px;
text-align: center;
font-weight: 600;
border: 1px solid #10b981;
}
.route-status.active {
display: block;
}
/* Informaci√≥n del recorrido */
.tour-info {
background: #e0f2fe;
color: #0277bd;
padding: 10px 15px;
border-radius: 8px;
margin: 10px auto;
max-width: 400px;
text-align: center;
font-size: 14px;
border: 1px solid #29b6f6;
}
/* Bot√≥n ir al recorrido en popup */
.popup-route-btn {
background: linear-gradient(135deg, #059669 0%, #047857 100%);
color: white;
border: none;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
font-size: 12px;
font-weight: 600;
margin-top: 8px;
width: 100%;
transition: all 0.3s ease;
box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
}
.popup-route-btn:hover {
background: linear-gradient(135deg, #047857 0%, #065f46 100%);
transform: translateY(-1px);
box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
}
.lang-switch {
position: absolute;
top: 10px;
right: 10px;
}
img {
max-width: 100%;
height: auto;
border-radius: 10px;
margin-bottom: 10px;
}
.popup-btn {
display: inline-block;
margin-top: 10px;
width: 100%;
text-align: center;
}
.btn-back {
background-color: #8B0000;
color: #fff;
padding: 10px 20px;
border: none;
border-radius: 8px;
font-size: 1.2em;
cursor: pointer;
margin-top: 20px;
margin-bottom: 40px;
transition: background-color 0.3s;
}
.btn-back:hover {
background-color: #a30000;
}
/* Popup simplificado */
.simple-popup {
text-align: center;
padding: 10px;
max-width: 200px;
}
.simple-popup h3 {
margin: 0 0 10px 0;
font-size: 16px;
font-weight: bold;
color: #8B0000;
}
.simple-popup img {
width: 100%;
height: 120px;
object-fit: cover;
border-radius: 8px;
margin: 0;
}
/* Responsive */
@media (max-width: 768px) {
#sidebar {
width: 100%;
right: -100%;
}
.carousel-images {
height: 200px;
}
.sidebar-header {
padding: 15px;
}
.sidebar-header h2 {
font-size: 1.2rem;
}
.image-carousel {
padding: 15px;
}
.site-description {
padding: 0 15px 15px;
}
.route-controls {
flex-direction: column;
align-items: center;
}
.popup-route-btn {
font-size: 11px;
padding: 6px 12px;
}
}
/* Scrollbar personalizado */
#sidebar::-webkit-scrollbar {
width: 6px;
}
#sidebar::-webkit-scrollbar-track {
background: #f1f5f9;
}
#sidebar::-webkit-scrollbar-thumb {
background: #cbd5e1;
border-radius: 3px;
}
#sidebar::-webkit-scrollbar-thumb:hover {
background: #94a3b8;
}
@media (max-width: 768px) {
  #siteButtons button {
    flex: 1 1 100%;
    max-width: 100%;
    font-size: 16px;
    padding: 12px;
  }

  #siteMenu h2 {
    font-size: 1.2rem;
  }
}

</style>
</head>
<body>
<header>
<img src="img/LogoINAH_Dorado.png" alt="Logo" class="logo">
<h1>Recorrido turistico cultural lado oriente</h1>
<div class="lang-switch">
<button id="btnEs" class="btn-red-vino">üá≤üáΩ Espa√±ol</button>
<button id="btnEn" class="btn-red-vino">üá∫üá∏ English</button>
</div>
</header>
<div id="description">
<p>Bienvenido al recorrido en coche por la ciudad de Campeche. Explora lugares hist√≥ricos y hermosos paisajes. Recorrer√°s sitios emblem√°ticos de la ciudad y conocer√°s su rica historia. Aseg√∫rate de disfrutar cada momento mientras avanzas en el recorrido. ¬°Comencemos!</p>
</div>
<div id="siteMenu" style="text-align: center; margin: 20px;">
<h2>üìç Sitios del Recorrido</h2>
<div id="siteButtons" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;"></div>
</div>
<div id="distance">Distancia al destino: -</div>

<!-- Informaci√≥n del recorrido -->
<div id="tourInfo" class="tour-info">
<span id="tourInfoText">üí° Haz clic en los iconos del mapa para crear rutas, o usa los botones de abajo para ver el recorrido completo</span>
</div>

<!-- Estado de ruta activa -->
<div id="routeStatus" class="route-status">
<span id="routeStatusText">Ruta activa a: </span>
</div>

<!-- Controles de ruta -->
<div class="route-controls">
<button id="startRouteBtn" class="btn-red-vino">üó∫Ô∏è Ver Recorrido Completo</button>
<button id="startTourBtn" class="btn-red-vino">üöó Ir al Primer Sitio</button>
<button id="cancelRouteBtn" class="btn-cancel" style="display: none;">‚ùå Cancelar Ruta</button>
<button id="clearAllRoutesBtn" class="btn-cancel" style="display: none;">üóëÔ∏è Limpiar Todo</button>
</div>

<div class="container" id="mapContainer">
<div id="map"></div>
<!-- Panel lateral -->
<div id="sidebar">
<div id="sidebar-content">
<!-- El contenido se genera din√°micamente -->
</div>
</div>
</div>
<div style="text-align: center;">
<a href="index.html">
<button class="btn-back">Regresar al Inicio</button>
</a>
</div>

<footer style="background-color:#702c37; color:#b38b28; text-align:center; padding:30px 10px; font-family: 'Arial', sans-serif;">
  <div style="margin-bottom: 20px;">
    <!-- Logo -->
    <img src="img/LogoINAH_Dorado2.png" alt="Logo" style="width:90px; margin-bottom:10px;">
  </div>

  <nav style="margin-bottom: 20px;">
    <a href="index.html" style="color:#b38b28; margin: 0 12px; text-decoration:none;">Inicio</a>
      <a href="acercaDe.html" style="color:#b38b28; margin: 0 12px; text-decoration:none;">Acerca De</a>
    <a href="https://www.google.com/maps?q=19.843044,-90.538832" target="_blank" style="color:#b38b28; margin: 0 12px; text-decoration:none;">
      Direcci√≥n
    </a>
    <a href="tel:+529818115510" style="color:#b38b28; margin: 0 12px; text-decoration:none;">
      Contacto
    </a>
  </nav>

  <div style="margin-bottom: 25px;">
    <!-- Redes sociales -->
      <a href="https://www.facebook.com/share/19GQgXUWKJ/?mibextid=wwXIfr" target="_blank" style="color:#b38b28; margin: 0 8px; font-size: 18px; text-decoration:none;">
      <i class="fab fa-facebook-f"></i> 
    </a>
    <a href="https://www.instagram.com/inahsasyuc?igsh=MTczMDg1NGxmYzRyNw==" target="_blank" style="color:#b38b28; margin: 0 8px; font-size: 18px; text-decoration:none;">
      <i class="fab fa-instagram"></i> 
    </a>
    <a href="https://x.com/inahsas_yuc" target="_blank" style="color:#b38b28; margin: 0 8px; font-size: 18px; text-decoration:none;">
      <i class="fab fa-twitter"></i> 
    </a>
    <a href="https://youtube.com/@inahtv?si=dTPfND_makjeZTEm" target="_blank" style="color:#b38b28; margin: 0 8px; font-size: 18px; text-decoration:none;">
      <i class="fab fa-youtube"></i> 
    </a>
  </div>

  <hr style="border-color: #8c5d54; margin-bottom: 15px;">

  <p style="font-size: 14px; margin: 0;">¬© 2025 Miguiaa_mx. Todos los derechos reservados.</p>
  <p style="font-weight: 600; font-size: 14px; margin: 5px 0 0 0;">DISE√ëADO POR INAH CAMPECHE</p>
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Variables globales
let map;
let userMarker;
let followUser = true;
let currentCarouselIndex = 0;
let carouselInterval;
let blueRouteLine;
let selectedRouteLine;
let selectedSite = null;
let routeToStartLine;
let distanceInterval;
let activeRouteType = null; // 'selected', 'start', 'complete'

// Funci√≥n para detectar si es dispositivo m√≥vil
function isMobileDevice() {
return window.innerWidth <= 768;
}

// Funci√≥n para hacer scroll suave hacia el contenedor del mapa en m√≥viles
function scrollToMapOnMobile() {
if (isMobileDevice()) {
const mapContainer = document.getElementById('mapContainer');
if (mapContainer) {
// Peque√±o delay para que la animaci√≥n del sidebar se complete
setTimeout(() => {
mapContainer.scrollIntoView({
behavior: 'smooth',
block: 'start'
});
}, 200);
}
}
}

// Inicializar mapa
const mapInstance = L.map('map').setView([19.843, -90.536], 16);
map = mapInstance;
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
// Desactiva el seguimiento si el usuario empieza a mover el mapa manualmente
map.on('movestart', () => {
followUser = false;
});
map.on('zoomend', () => {
  const zoom = map.getZoom();
  let size = 32;

  if (zoom >= 17) size = 64;
  else if (zoom >= 15) size = 48;
  else if (zoom >= 13) size = 36;
  else size = 28;

  siteIcons = createIcon(size);
  markers.forEach(({ marker, site }) => {
    marker.setIcon(siteIcons[site.name]);
  });
});


const translations = {
es: {
  welcome: 'Bienvenido al recorrido en auto por la ciudad de Campeche. Explora lugares hist√≥ricos y paisajes hermosos. Visitar√°s sitios emblem√°ticos de la ciudad y conocer√°s su rica historia. Aseg√∫rate de disfrutar cada momento mientras avanzas en el recorrido. ¬°Comencemos!',
distance: 'Distancia al destino',
closeSidebar: 'Cerrar',
prevImage: 'Anterior',
nextImage: 'Siguiente',
listenDescription: 'Escuchar descripci√≥n',
centerMap: 'Centrar en mapa',
createRoute: 'Crear Ruta a Este Sitio',
meters: 'metros',
kilometers: 'kil√≥metros',
viewCompleteRoute: 'üó∫Ô∏è Ver Recorrido Completo',
goToFirstSite: 'üöó Ir al Primer Sitio',
cancelRoute: '‚ùå Cancelar Ruta',
clearAll: 'üóëÔ∏è Limpiar Todo',
routeActive: 'Ruta activa a: ',
routeToStart: 'Ruta al sitio m√°s cercano',
routeCanceled: 'Ruta cancelada',
allRoutesCleared: 'Todas las rutas eliminadas',
tourInfoDefault: 'üí° Haz clic en los iconos del mapa para crear rutas, o usa los botones de abajo para ver el recorrido completo',
tourInfoComplete: 'üó∫Ô∏è Mostrando recorrido completo entre todos los sitios',
tourInfoToSite: 'üöó Ruta creada desde tu ubicaci√≥n hasta el sitio m√°s cercano',
goToRoute: 'üöó Ir al Recorrido',
routeCreated: 'Ruta creada hacia',
locationNotAvailable: 'Ubicaci√≥n no disponible',

  puerta_de_mar: {
    description: 'La Puerta de Mar se encuentra en la Calle 8 entre 57 y 61. Bienvenido. Este acceso fue construido en 1710 sobre la antigua l√≠nea de la costa y sirvi√≥ como entrada y salida para los viajeros y navegantes que transitaron por este puerto, el m√°s importante de la pen√≠nsula de Yucat√°n durante la √©poca virreinal.',
    images: ['imgOriente/VaporLola1.jpg', 'imgOriente/VaporLola2.jpg', 'imgOriente/VaporLola3.jpg']
  },
  baluarte_carlos: {
    description: 'El Baluarte de San Carlos se encuentra en la Calle 8 entre 10 y 63. El Baluarte de San Carlos fue el primero del sistema fortificado de Campeche en construirse a finales del siglo XVII. Su nombre fue otorgado en honor al Rey Carlos II de Espa√±a.',
    images: ['imgOriente/sanLuis1.jpg', 'imgOriente/sanLuis2.jpg', 'imgOriente/sanLuis3.jpg']
  },
  templo_san_jose: {
    description: 'El Ex Templo se encuentra en la Calle 10 entre 63 y 65. Esta iglesia dedicada a San Jos√©, patrono de los carpinteros, fue sede de la cofrad√≠a del gremio de marinos, carpinteros de ribera y calafateros del puerto de Campeche. Se encontraba cerca del primer astillero en donde el pirata ‚ÄúLorencillo‚Äù incendi√≥ dos fragatas en construcci√≥n durante su ataque a la villa en 1672.',
    images: ['imgOriente/sanMiguel1.jpg', 'imgOriente/sanMiguel2.jpg', 'imgOriente/sanMiguel3.jpg']
  },
  escuela_nautica: {
    description: 'La Ex Escuela Na√∫tica se encuentra en la Calle 63 entre 10 y 12. La escuela fue inaugurada el 24 de febrero de 1822 instal√°ndose de manera provisional en el colegio de San Jos√© hasta su traslado a este local donde perdur√≥ hasta 1894.',
    images: ['imgOriente/parqueLerma1.jpg', 'imgOriente/parqueLerma2.jpg', 'imgOriente/parqueLerma3.jpg']
  },
  puerta_de_tierra: {
    description: 'La Puerta de Tierra se encuentra en la Calle 18 entre 59 y 61. Esta puerta se encuentra del lado opuesto a la Puerta de Mar, como su nombre lo indica era el principal acceso por v√≠a terrestre a la ciudad amurallada.',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  },
  ca√±on_bronce: {
    description: 'El Ca√±√≥n de Bronce se encuentra en la Puerta de Tierra ubicada en la Calle 18 entre 58 y 61. Este magn√≠fico ca√±√≥n del siglo XVIII fundido en bronce fue localizado por pescadores locales en las profundidades de la bah√≠a de Campeche, cerca del poblado de Lerma.',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  },
  baluarte_pedro: {
    description: 'El Baluarte de San Pedro se encuentra en la Calle 18 entre 16 y 53. La construcci√≥n de este baluarte fue financiada por el clero diocesano de la villa de San Francisco de Campeche, por lo que se puede observar en la entrada de este recinto el escudo de armas del Vaticano conformado por las llaves del cielo y la tiara papal.',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  },
  hospital_juan: {
    description: 'El Ex Hospital se encuentra en la Calle 16 entre 49 y 53. En 1626 llegaron a la villa de San Francisco de Campeche la orden de los Hospitalarios de San Juan de Dios, dedicados a la caridad y a la atenci√≥n de los enfermos. Fundaron un hospital con una capilla construidos con los donativos de los habitantes y de los marinos y soldados de los buques que atracaban en el muelle',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  },
  aduana_maritima: {
    description: 'La Ex Aduana se encuentra ubicada en la Calle 8 entre 53 y 55. Este conjunto data de 1778 cuando al puerto de Campeche se le permiti√≥ comerciar libremente con otros puertos de Espa√±a y Am√©rica. El tr√°fico mar√≠timo se revitaliz√≥ en este periodo, realiz√°ndose mejoras en su infraestructura portuaria con la remodelaci√≥n del muelle fiscal y la construcci√≥n de la Casa Aduana',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  }
},
en: {
  welcome: 'Welcome to the car tour through the city of Campeche. Explore historical places and beautiful landscapes. You will visit emblematic sites of the city and learn about its rich history. Be sure to enjoy every moment as you progress through the tour. Let\'s get started!',
distance: 'Distance to destination',
closeSidebar: 'Close',
prevImage: 'Previous',
nextImage: 'Next',
listenDescription: 'Listen to description',
centerMap: 'Center on map',
createRoute: 'Create Route to This Site',
meters: 'meters',
kilometers: 'kilometers',
viewCompleteRoute: 'üó∫Ô∏è View Complete Route',
goToFirstSite: 'üöó Go to First Site',
cancelRoute: '‚ùå Cancel Route',
clearAll: 'üóëÔ∏è Clear All',
routeActive: 'Active route to: ',
routeToStart: 'Route to nearest site',
routeCanceled: 'Route canceled',
allRoutesCleared: 'All routes cleared',
tourInfoDefault: 'üí° Click on map icons to create routes, or use the buttons below to view the complete tour',
tourInfoComplete: 'üó∫Ô∏è Showing complete route between all sites',
tourInfoToSite: 'üöó Route created from your location to the nearest site',
goToRoute: 'üöó Go to Route',
routeCreated: 'Route created to',
locationNotAvailable: 'Location not available',

  puerta_de_mar: {
    description: 'The Puerta de Mar is located on 8th Street between 57th and 61st Streets. This access was built in 1710 on the old coastline and served as an entrance and exit for travelers and sailors who passed through this port, the most important on the Yucat√°n Peninsula during the viceregal era.',
    images: ['imgOriente/VaporLola1.jpg', 'imgOriente/VaporLola2.jpg', 'imgOriente/VaporLola3.jpg']
  },
  baluarte_carlos: {
    description: 'The bastion of San Carlos is located on Street 8 between 10 and 63. The San Carlos Bastion was the first of Campeches fortified system to be built at the end of the 17th century. Its name was given in honor of King Charles II of Spain.',
    images: ['imgOriente/sanLuis1.jpg', 'imgOriente/sanLuis2.jpg', 'imgOriente/sanLuis3.jpg']
  },
  templo_san_jose: {
    description: 'The former church is located on 10th Street between 63rd and 65th Streets. This church, dedicated to Saint Joseph, patron saint of carpenters, was the headquarters of the guild of sailors, shipwrights, and caulkers of the port of Campeche. It was located near the first shipyard where the pirate Lorencillo burned two frigates under construction during his attack on the town in 1672.',
    images: ['imgOriente/sanMiguel1.jpg', 'imgOriente/sanMiguel2.jpg', 'imgOriente/sanMiguel3.jpg']
  },
  escuela_nautica: {
    description: 'The former Nautical School is located on 63rd Street between 10th and 12th Streets. The school was inaugurated on February 24, 1822, and was temporarily housed in the Colegio de San Jos√© until its relocation to this location, where it remained until 1894.',
    images: ['imgOriente/parqueLerma1.jpg', 'imgOriente/parqueLerma2.jpg', 'imgOriente/parqueLerma3.jpg']
  },
  puerta_de_tierra: {
    description: 'The Land Gate is located on 18th Street between 59th and 61st Streets. This gate is located opposite the Sea Gate. As its name suggests, it was the main land access to the walled city.',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  },
  ca√±on_bronce: {
    description: 'The Bronze Cannon is located at the Land Gate on 18th Street between 59th and 61st Streets. This magnificent 18th-century bronze cannon was found by local fishermen in the depths of the Bay of Campeche, near the town of Lerma.',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  },
  baluarte_pedro: {
    description: 'The Bastion of Saint Peter is located on 18th Street between 16th and 53rd Streets. The construction of this bastion was financed by the diocesan clergy of the town of San Francisco de Campeche, which is why the Vatican coat of arms, consisting of the keys to heaven and the papal tiara, can be seen at the entrance to this enclosure.',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  },
  hospital_juan: {
    description: 'The former hospital is located on 16th Street between 49th and 53rd Streets. In 1626, the Order of the Hospitallers of Saint John of God arrived in the town of San Francisco de Campeche, dedicated to charity and the care of the sick. They founded a hospital with a chapel, built with donations from the residents and sailors and soldiers from the ships that docked at the pier.',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  },
  aduana_maritima: {
    description: 'The former Customs House is located on 8th Street between 53rd and 55th Streets. This complex dates back to 1778, when the port of Campeche was allowed to trade freely with other ports in Spain and the Americas. Maritime traffic was revitalized during this period, with improvements to its port infrastructure including the remodeling of the fiscal pier and the construction of the Customs House',
    images: ['imgOriente/playaBonita1.jpg', 'imgOriente/playaBonita2.jpg', 'imgOriente/playaBonita3.jpg']
  }
}
};


let currentLang = 'es';
const sites = [
  { id: 'puerta_de_mar', lat: 19.845839, lng: -90.538424, name: 'Puerta de Mar', image: 'img/VaporLola.jpg' },
  { id: 'baluarte_carlos', lat: 19.844538, lng: -90.540437, name: 'Baluarte de San Carlos', image: 'img/VaporLola.jpg' },
  { id: 'sitio_extra', lat: 19.843842, lng: -90.540406, extra: true },
  { id: 'templo_san_jose', lat: 19.844209, lng: -90.539609, name: 'Ex Templo y Colegio San Jose', image: 'img/VaporLola.jpg' },
  { id: 'escuela_nautica', lat: 19.843955, lng: -90.539467, name: 'Ex Escuela Nautica', image: 'img/VaporLola.jpg' },
  { id: 'sitio_extra2', lat: 19.843470, lng: -90.539220, extra: true },
  { id: 'sitio_extra3', lat: 19.842815, lng: -90.540510, extra: true },
  { id: 'sitio_extra4', lat: 19.841423, lng: -90.540246, extra: true },
  { id: 'puerta_de_tierra', lat: 19.841454, lng: -90.536070, name: 'Puerta de Tierra', image: 'img/VaporLola.jpg' },
  { id: 'ca√±on_bronce', lat: 19.841440, lng: -90.536050, name: 'Ca√±on de Bronce', image: 'img/VaporLola.jpg' },
  { id: 'baluarte_pedro', lat: 19.843064, lng: -90.532342, name: 'Baluarte de San Pedro', image: 'img/VaporLola.jpg' },
  { id: 'hospital_juan', lat: 19.843835, lng: -90.532751, name: 'Ex Hospital San Juan de Dios', image: 'img/VaporLola.jpg' },
  { id: 'sitio_extra5', lat: 19.844428, lng: -90.532940, extra: true },
  { id: 'sitio_extra6', lat: 19.846113, lng: -90.533356, extra: true },
  { id: 'sitio_extra7', lat: 19.846894, lng: -90.534002, extra: true },
  { id: 'sitio_extra8', lat: 19.847531, lng: -90.534617, extra: true },
  { id: 'aduana_maritima', lat: 19.846378, lng: -90.536814, name: 'Ex Aduana Maritima', image: 'img/VaporLola.jpg' },
  { id: 'sitio_extra9', lat: 19.845751, lng: -90.536513, extra: true },
  { id: 'sitio_extra10', lat: 19.845397, lng: -90.537187, extra:true },
  { id: 'sitio_extra11', lat: 19.845839, lng: -90.538424, extra: true },
];
const validSites = sites.filter(site => !site.extra);



// Crear popup SIMPLE para iconos del mapa (solo imagen, t√≠tulo y bot√≥n)
function createSimplePopup(site) {
  return `
  <div class="simple-popup">
    <h3>${site.name}</h3>
    <img src="${site.image}" alt="${site.name}">
    <button onclick="startRouteToSite('${site.id}')" class="popup-route-btn">
      ${translations[currentLang].goToRoute}
    </button>
  </div>
  `;
}

// Funci√≥n para iniciar ruta desde popup
function startRouteToSite(siteId) {
  if (!userMarker) {
    console.log('Ubicaci√≥n del usuario no disponible');
    return;
  }

  // Cancelar cualquier ruta existente autom√°ticamente
  if (selectedRouteLine) {
    map.removeLayer(selectedRouteLine);
    selectedRouteLine = null;
  }

  if (routeToStartLine) {
    map.removeLayer(routeToStartLine);
    routeToStartLine = null;
  }

  if (blueRouteLine) {
    map.removeLayer(blueRouteLine);
    blueRouteLine = null;
  }

  // Crear nueva ruta al sitio seleccionado
  const site = sites.find(s => s.id === siteId);
  if (site) {
    selectedSite = site;
    drawRouteToSite(site.lat, site.lng, site.name);
  }

  // Cerrar popup
  map.closePopup();
  closeSidebar();
}

// Funci√≥n para crear ruta desde el panel lateral
function createRouteFromSidebar(siteId) {
  const site = sites.find(s => s.id === siteId);
  if (!site) return;

  if (!userMarker) {
    console.log('Ubicaci√≥n del usuario no disponible');
    return;
  }

  // Cancelar cualquier ruta existente autom√°ticamente
  if (selectedRouteLine) {
    map.removeLayer(selectedRouteLine);
    selectedRouteLine = null;
  }

  if (routeToStartLine) {
    map.removeLayer(routeToStartLine);
    routeToStartLine = null;
  }

  if (blueRouteLine) {
    map.removeLayer(blueRouteLine);
    blueRouteLine = null;
  }

  // Crear nueva ruta al sitio seleccionado
  selectedSite = site;
  drawRouteToSite(site.lat, site.lng, site.name);
  closeSidebar();
}

function createIcon(size = 48) {
  return {
    'puerta_de_mar': L.icon({
      iconUrl: '/Recorrido_peatonal/iconos/muralla.jpeg',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    }),
    'baluarte_carlos': L.icon({
      iconUrl: 'iconos/baterias.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    }),
    'templo_san_jose': L.icon({
      iconUrl: 'iconos/fuerte.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    }),
    'escuela_nautica': L.icon({
      iconUrl: 'iconos/parque.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    }),
    'puerta_de_tierra': L.icon({
      iconUrl: 'iconos/playa.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    }),
    'ca√±on_bronce': L.icon({
      iconUrl: 'iconos/playa.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    }),
    'baluarte_pedro': L.icon({
      iconUrl: 'iconos/playa.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    }),
    'hospital_juan': L.icon({
      iconUrl: 'iconos/playa.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    }),
    'aduana_maritima': L.icon({
      iconUrl: 'iconos/playa.png',
      iconSize: [size, size],
      iconAnchor: [size / 2, size],
      popupAnchor: [0, -size]
    })
  };
}


const markers = [];
const siteIcons = createIcon(); // tama√±o inicial

sites.forEach(site => {
  if (!site.extra) {
    const marker = L.marker([site.lat, site.lng], {
      icon: siteIcons[site.id]
    }).addTo(map);

    marker.bindPopup(createSimplePopup(site));
    markers.push({ marker, site });
  }
});

// Actualizar estado de la interfaz seg√∫n rutas activas
function updateRouteUI() {
const routeStatus = document.getElementById('routeStatus');
const routeStatusText = document.getElementById('routeStatusText');
const tourInfo = document.getElementById('tourInfo');
const tourInfoText = document.getElementById('tourInfoText');
const viewRouteBtn = document.getElementById('startRouteBtn');
const goToSiteBtn = document.getElementById('startTourBtn');
const cancelBtn = document.getElementById('cancelRouteBtn');
const clearBtn = document.getElementById('clearAllRoutesBtn');

if (selectedSite && selectedRouteLine) {
// Hay una ruta espec√≠fica a un sitio
routeStatus.classList.add('active');
routeStatusText.textContent = `${translations[currentLang].routeActive}${selectedSite.name}`;
tourInfoText.textContent = `üéØ Ruta espec√≠fica creada hacia: ${selectedSite.name}`;
cancelBtn.style.display = 'inline-block';
clearBtn.style.display = 'inline-block';
activeRouteType = 'selected';
} else if (routeToStartLine) {
// Hay una ruta al sitio m√°s cercano
routeStatus.classList.add('active');
routeStatusText.textContent = translations[currentLang].routeToStart;
tourInfoText.textContent = translations[currentLang].tourInfoToSite;
cancelBtn.style.display = 'inline-block';
clearBtn.style.display = 'inline-block';
activeRouteType = 'start';
} else if (blueRouteLine) {
// Solo hay ruta completa del recorrido
routeStatus.classList.remove('active');
tourInfoText.textContent = translations[currentLang].tourInfoComplete;
clearBtn.style.display = 'inline-block';
cancelBtn.style.display = 'none';
activeRouteType = 'complete';
} else {
// No hay rutas activas
routeStatus.classList.remove('active');
tourInfoText.textContent = translations[currentLang].tourInfoDefault;
cancelBtn.style.display = 'none';
clearBtn.style.display = 'none';
activeRouteType = null;
}

// Actualizar textos de botones
viewRouteBtn.textContent = translations[currentLang].viewCompleteRoute;
goToSiteBtn.textContent = translations[currentLang].goToFirstSite;
cancelBtn.textContent = translations[currentLang].cancelRoute;
clearBtn.textContent = translations[currentLang].clearAll;
}

// Cancelar ruta activa
function cancelActiveRoute() {
  try {
    if (selectedRouteLine && map.hasLayer(selectedRouteLine)) {
      map.removeLayer(selectedRouteLine);
      selectedRouteLine = null;
    }

    if (routeToStartLine && map.hasLayer(routeToStartLine)) {
      map.removeLayer(routeToStartLine);
      routeToStartLine = null;
    }

    selectedSite = null;
    localStorage.removeItem('selectedSite');
    document.getElementById('distance').innerText = 'Distancia al destino: -';

    updateRouteUI();
  } catch (error) {
    console.error('Error al cancelar ruta:', error);
  }
}

// Limpiar todas las rutas
function clearAllRoutes() {
  try {
    if (selectedRouteLine && map.hasLayer(selectedRouteLine)) {
      map.removeLayer(selectedRouteLine);
      selectedRouteLine = null;
    }

    if (routeToStartLine && map.hasLayer(routeToStartLine)) {
      map.removeLayer(routeToStartLine);
      routeToStartLine = null;
    }

    if (blueRouteLine && map.hasLayer(blueRouteLine)) {
      map.removeLayer(blueRouteLine);
      blueRouteLine = null;
    }

    selectedSite = null;
    localStorage.removeItem('selectedSite');
    document.getElementById('distance').innerText = 'Distancia al destino: -';

    updateRouteUI();
  } catch (error) {
    console.error('Error al limpiar rutas:', error);
  }
}



// Abrir panel lateral con informaci√≥n del sitio (SOLO desde botones del men√∫)
function openSidebar(siteName) {
const site = sites.find(s => s.id === siteName);

if (!site) return;
const sidebar = document.getElementById('sidebar');
const sidebarContent = document.getElementById('sidebar-content');
// Detener carrusel anterior si existe
if (carouselInterval) {
clearInterval(carouselInterval);
}
// Calcular distancia si hay ubicaci√≥n del usuario
let distanceInfo = '';
if (userMarker) {
const userPos = userMarker.getLatLng();
const sitePos = L.latLng([site.lat, site.lng]);
const distance = userPos.distanceTo(sitePos);
const distanceText = distance > 1000
? `${(distance / 1000).toFixed(2)} ${translations[currentLang].kilometers}`
: `${Math.round(distance)} ${translations[currentLang].meters}`;
distanceInfo = `
<div class="distance-info">
<span class="distance-label">${translations[currentLang].distance}:</span>
<span class="distance-value">${distanceText}</span>
</div>
`;
}
const siteData = translations[currentLang][siteName];
const images = siteData.images || [site.image];
sidebarContent.innerHTML = `
<div class="sidebar-header">
<div class="header-content">
<h2>${siteName}</h2>
${distanceInfo}
</div>
<button onclick="closeSidebar()" class="close-btn">
‚úï ${translations[currentLang].closeSidebar}
</button>
</div>
<div class="image-carousel">
<div class="carousel-container">
<div class="carousel-images" id="carousel-images">
${images.map((img, index) => `
<img src="${img}" alt="${siteName}"
class="carousel-image ${index === 0 ? 'active' : ''}"
data-index="${index}"
onerror="this.src='${site.image}'">
`).join('')}
</div>
${images.length > 1 ? `
<div class="carousel-controls">
<button onclick="prevImage()" class="carousel-btn prev-btn">
‚ùÆ ${translations[currentLang].prevImage}
</button>
<div class="carousel-indicators">
${images.map((_, index) => `
<span class="indicator ${index === 0 ? 'active' : ''}"
onclick="goToImage(${index})" data-index="${index}"></span>
`).join('')}
</div>
<button onclick="nextImage()" class="carousel-btn next-btn">
${translations[currentLang].nextImage} ‚ùØ
</button>
</div>
<div class="carousel-progress">
<div class="progress-bar" id="progress-bar"></div>
</div>
` : ''}
</div>
</div>
<div class="site-description">
<p>${siteData.description}</p>
<div class="action-buttons">
<button onclick="speakDescription('${siteData.description.replace(/'/g, "\\'")}', '${siteName.replace(/'/g, "\\'")}'); return false;" class="speak-btn">
üîä ${translations[currentLang].listenDescription}
</button>
<button onclick="toggleSpeech();" id="pauseBtn" class="speak-btn" style="display: none;">
  ‚è∏Ô∏è Pausar
</button>

<button onclick="centerMapOnSite(${site.lat}, ${site.lng})" class="center-btn">
üéØ ${translations[currentLang].centerMap}
</button>
<button onclick="createRouteFromSidebar('${siteName}')" class="route-btn">
üöó ${translations[currentLang].createRoute}
</button>
</div>
</div>
`;
// Mostrar sidebar
sidebar.classList.add('active');

// Hacer scroll hacia el mapa en dispositivos m√≥viles
scrollToMapOnMobile();

// Inicializar carrusel autom√°tico solo si hay m√∫ltiples im√°genes
if (images.length > 1) {
currentCarouselIndex = 0;
startCarousel(images.length);
updateProgressBar();
}
}

// Cerrar panel lateral
function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.remove('active');

  // Detener carrusel
  if (carouselInterval) {
    clearInterval(carouselInterval);
  }

  // SOLO PAUSAR (NO CANCELAR)
  if ('speechSynthesis' in window && speechSynthesis.speaking && !speechSynthesis.paused) {
    speechSynthesis.pause();
    isPaused = true;
    const pauseBtn = document.getElementById('pauseBtn');
    if (pauseBtn) pauseBtn.innerText = '‚ñ∂Ô∏è Reanudar';
  }
}


// Iniciar carrusel autom√°tico
function startCarousel(totalImages) {
updateProgressBar();
carouselInterval = setInterval(() => {
nextImage(totalImages);
updateProgressBar();
}, 4000);
}

// Actualizar barra de progreso del carrusel
function updateProgressBar() {
const progressBar = document.getElementById('progress-bar');
if (progressBar) {
progressBar.style.width = '0%';
progressBar.style.transition = 'width 4s linear';
setTimeout(() => {
progressBar.style.width = '100%';
}, 50);
}
}

// Navegar a imagen anterior
function prevImage() {
const images = document.querySelectorAll('.carousel-image');
const indicators = document.querySelectorAll('.indicator');
if (images.length === 0) return;
images[currentCarouselIndex].classList.remove('active');
if (indicators[currentCarouselIndex]) indicators[currentCarouselIndex].classList.remove('active');
currentCarouselIndex = currentCarouselIndex === 0 ? images.length - 1 : currentCarouselIndex - 1;
images[currentCarouselIndex].classList.add('active');
if (indicators[currentCarouselIndex]) indicators[currentCarouselIndex].classList.add('active');
// Reiniciar carrusel autom√°tico
if (carouselInterval) {
clearInterval(carouselInterval);
startCarousel(images.length);
}
}

// Navegar a imagen siguiente
function nextImage(totalImages = null) {
const images = document.querySelectorAll('.carousel-image');
const indicators = document.querySelectorAll('.indicator');
if (images.length === 0) return;
const total = totalImages || images.length;
images[currentCarouselIndex].classList.remove('active');
if (indicators[currentCarouselIndex]) indicators[currentCarouselIndex].classList.remove('active');
currentCarouselIndex = (currentCarouselIndex + 1) % total;
images[currentCarouselIndex].classList.add('active');
if (indicators[currentCarouselIndex]) indicators[currentCarouselIndex].classList.add('active');
}

// Ir a imagen espec√≠fica
function goToImage(index) {
const images = document.querySelectorAll('.carousel-image');
const indicators = document.querySelectorAll('.indicator');
if (images.length === 0) return;
images[currentCarouselIndex].classList.remove('active');
if (indicators[currentCarouselIndex]) indicators[currentCarouselIndex].classList.remove('active');
currentCarouselIndex = index;
images[currentCarouselIndex].classList.add('active');
if (indicators[currentCarouselIndex]) indicators[currentCarouselIndex].classList.add('active');
// Reiniciar carrusel autom√°tico
if (carouselInterval) {
clearInterval(carouselInterval);
startCarousel(images.length);
}
}

// Funci√≥n para text-to-speech
let isPaused = false;

function speakDescription(text, title) {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel(); // detener cualquier lectura anterior

    const fullText = `${title}. ${text}`;
    const utterance = new SpeechSynthesisUtterance(fullText);
    utterance.lang = currentLang === 'es' ? 'es-MX' : 'en-US';
    utterance.rate = 0.8;

    const speakBtn = document.querySelector('.speak-btn');
    const pauseBtn = document.getElementById('pauseBtn');

    if (speakBtn) {
      const originalText = speakBtn.innerHTML;
      speakBtn.innerHTML = '‚è∏Ô∏è Reproduciendo...';
      speakBtn.disabled = true;
      if (pauseBtn) {
        pauseBtn.style.display = 'inline-block';
        pauseBtn.innerText = '‚è∏Ô∏è Pausar';
        isPaused = false;
      }

      utterance.onend = () => {
        speakBtn.innerHTML = originalText;
        speakBtn.disabled = false;
        if (pauseBtn) {
          pauseBtn.style.display = 'none';
        }
        isPaused = false;
      };

      utterance.onerror = () => {
        speakBtn.innerHTML = originalText;
        speakBtn.disabled = false;
        if (pauseBtn) {
          pauseBtn.style.display = 'none';
        }
        isPaused = false;
      };
    }

    speechSynthesis.speak(utterance);
  }
}

function toggleSpeech() {
  const pauseBtn = document.getElementById('pauseBtn');
  if ('speechSynthesis' in window && speechSynthesis.speaking) {
    if (isPaused) {
      speechSynthesis.resume();
      pauseBtn.innerText = '‚è∏Ô∏è Pausar';
      isPaused = false;
    } else {
      speechSynthesis.pause();
      pauseBtn.innerText = '‚ñ∂Ô∏è Reanudar';
      isPaused = true;
    }
  }
}




// Centrar mapa en sitio espec√≠fico
function centerMapOnSite(lat, lng) {
map.setView([lat, lng], 16);
closeSidebar();
}

// Geolocalizaci√≥n
if (navigator.geolocation) {
navigator.geolocation.watchPosition(onLocationFound, onLocationError, {
enableHighAccuracy: true,
timeout: 10000,
maximumAge: 0
});
} else {
console.log('La geolocalizaci√≥n no est√° disponible en este dispositivo.');
}

function onLocationFound(position) {
const userLocation = L.latLng(position.coords.latitude, position.coords.longitude);
if (!userMarker) {
userMarker = L.marker(userLocation).addTo(map).bindPopup('Tu ubicaci√≥n').openPopup();
} else {
userMarker.setLatLng(userLocation);
}

if (selectedSite) {
drawRouteToSite(selectedSite.lat, selectedSite.lng, selectedSite.name);
}
}

function onLocationError(e) {
console.error('Error de geolocalizaci√≥n:', e.message);
}

// Funciones de rutas (manteniendo la funcionalidad original)
function getOSRMRoute(sites) {
  if (blueRouteLine) {
    map.removeLayer(blueRouteLine);
    blueRouteLine = null;
  }

  const apiKey = '5b3ce3597851110001cf6248c9b1e96ff9054bb699426b242c8eaf45'; // ‚Üê Reemplaza con tu API key de ORS
  const url = 'https://api.openrouteservice.org/v2/directions/foot-walking/geojson';

  const routeSegments = [];
  let currentIndex = 0;

  function fetchNextSegment() {
    if (currentIndex >= sites.length - 1) {
      // Todas las rutas fueron trazadas, unirlas en una sola l√≠nea azul
      const allCoords = routeSegments.flat();
      blueRouteLine = L.polyline(allCoords, {
        color: 'blue',
        weight: 2
      }).addTo(map);
      map.fitBounds(blueRouteLine.getBounds());
      document.getElementById('tourInfoText').innerText =
        translations[currentLang].tourInfoComplete;
      return;
    }

    const from = sites[currentIndex];
    const to = sites[currentIndex + 1];
    const coordinates = [[from.lng, from.lat], [to.lng, to.lat]];

    fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': apiKey,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ coordinates })
    })
      .then(res => res.json())
      .then(data => {
        const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        routeSegments.push(coords);
        currentIndex++;
        fetchNextSegment();
      })
      .catch(err => {
        console.error(`Error al trazar tramo ${currentIndex + 1}:`, err);
      });
  }

  fetchNextSegment();
}

function drawRouteToSite(destLat, destLng, siteName) {
  if (!userMarker) {
    console.log('Ubicaci√≥n del usuario no disponible.');
    return;
  }

  const userLocation = userMarker.getLatLng();
  const coords = [[userLocation.lng, userLocation.lat], [destLng, destLat]];

  const url = 'https://api.openrouteservice.org/v2/directions/foot-walking/geojson';
  const apiKey = '5b3ce3597851110001cf6248c9b1e96ff9054bb699426b242c8eaf45'; // reemplaza con tu clave

  // Eliminar rutas anteriores
  if (selectedRouteLine) {
    map.removeLayer(selectedRouteLine);
    selectedRouteLine = null;
  }

  fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': apiKey,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      coordinates: coords
    })
  })
    .then(res => res.json())
    .then(data => {
      const routeCoords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      selectedRouteLine = L.polyline(routeCoords, { color: 'red', weight: 5 }).addTo(map);

      if (!userMovedMap) {
        map.fitBounds(selectedRouteLine.getBounds());
      }

      // Distancia y duraci√≥n
      const dist = (data.features[0].properties.summary.distance / 1000).toFixed(2);
      const durationMin = Math.ceil(data.features[0].properties.summary.duration / 60);

      document.getElementById('distance').innerText =
        `${translations[currentLang].distance}: ${dist} km`;

      selectedSite = { lat: destLat, lng: destLng, name: siteName };
      localStorage.setItem('selectedSite', JSON.stringify(selectedSite));

      updateRouteUI();
      activeRouteType = 'selected';
    })
    .catch(err => {
      console.error('Error al trazar ruta:', err);
    });
}

// Crear men√∫ de sitios - SOLO ABRE EL PANEL LATERAL (sin afectar el mapa)
function createSiteMenu() {
const container = document.getElementById('siteButtons');
container.innerHTML = '';
sites.forEach(site => {
  if (site.extra) return; // ‚Üê ignora sitios extra

  const btn = document.createElement('button');
  btn.className = 'btn-red-vino';
  btn.innerText = site.name;
  btn.onclick = () => {
  openSidebar(site.id); // usa site.id que coincide con los datos del diccionario `translations`
};

  document.getElementById('siteButtons').appendChild(btn);
});
}

// Cambio de idioma
document.getElementById('btnEs').addEventListener('click', () => {
currentLang = 'es';
updateUI();
});
document.getElementById('btnEn').addEventListener('click', () => {
currentLang = 'en';
updateUI();
});

// Event listeners para botones de control de rutas
document.getElementById('cancelRouteBtn').addEventListener('click', cancelActiveRoute);
document.getElementById('clearAllRoutesBtn').addEventListener('click', clearAllRoutes);

function updateUI() {
document.querySelector('#description p').innerText = translations[currentLang].welcome;
// Actualizar popups simples de los marcadores
markers.forEach(({ marker, site }) => {
marker.setPopupContent(createSimplePopup(site));
});
closeSidebar();
updateRouteUI();
}

// Bot√≥n ver recorrido completo
// Bot√≥n ver recorrido completo
document.getElementById('startRouteBtn').addEventListener('click', () => {
  // Limpiar rutas espec√≠ficas si existen
  if (selectedRouteLine) {
    map.removeLayer(selectedRouteLine);
    selectedRouteLine = null;
  }
  if (routeToStartLine) {
    map.removeLayer(routeToStartLine);
    routeToStartLine = null;
  }

  selectedSite = null;
  localStorage.removeItem('selectedSite');
  document.getElementById('distance').innerText = 'Distancia al destino: -';

  // Mostrar ruta completa
  if (!blueRouteLine) {
    getOSRMRoute(validSites); // ‚úÖ usamos solo sitios v√°lidos (sin extras)
  } else {
    map.fitBounds(blueRouteLine.getBounds());
  }

  updateRouteUI();
});

// Bot√≥n ir al primer sitio (sitio m√°s cercano)
document.getElementById('startTourBtn').addEventListener('click', () => {
if (!userMarker) {
console.log('Ubicaci√≥n del usuario no disponible.');
return;
}

const userLocation = userMarker.getLatLng();
const nearest = sites.reduce((a, b) => {
const d1 = userLocation.distanceTo([a.lat, a.lng]);
const d2 = userLocation.distanceTo([b.lat, b.lng]);
return d1 < d2 ? a : b;
});

const start = `${userLocation.lng},${userLocation.lat}`;
const end = `${nearest.lng},${nearest.lat}`;
const url = 'https://api.openrouteservice.org/v2/directions/foot-walking/geojson';
const apiKey = '5b3ce3597851110001cf6248c9b1e96ff9054bb699426b242c8eaf45'; // üîÅ Pon aqu√≠ tu API Key

fetch(url, {
  method: 'POST',
  headers: {
    'Authorization': apiKey,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    coordinates: [[userLocation.lng, userLocation.lat], [nearest.lng, nearest.lat]]
  })
})
  .then(res => res.json())
  .then(data => {
    const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
    if (routeToStartLine) map.removeLayer(routeToStartLine);
    routeToStartLine = L.polyline(coords, {
      color: 'green',
      weight: 5,
      dashArray: '10, 5'
    }).addTo(map);

    map.fitBounds(routeToStartLine.getBounds());

    const dist = (data.features[0].properties.summary.distance / 1000).toFixed(2);
    document.getElementById('distance').innerText =
      `${translations[currentLang].distance}: ${dist} km`;

    updateRouteUI();
  })
  .catch(err => {
    console.error('Error al trazar ruta con ORS:', err);
  });
});

// Al cargar la p√°gina
window.addEventListener('load', () => {
const saved = localStorage.getItem('selectedSite');
if (saved) {
const site = JSON.parse(saved);
selectedSite = site;
drawRouteToSite(site.lat, site.lng, site.name);
}
});

// Inicializar
getOSRMRoute(sites);
createSiteMenu();

// Limpiar recursos al cerrar
// Al cargar la p√°gina
window.addEventListener('load', () => {
  const saved = localStorage.getItem('selectedSite');
  if (saved) {
    const site = JSON.parse(saved);
    selectedSite = site;
    drawRouteToSite(site.lat, site.lng, site.name);
  }

  getOSRMRoute(validSites);  // ‚úÖ Aqu√≠ se asegura de que el mapa ya est√© listo
  createSiteMenu();
});


// Manejar cambios de visibilidad de la p√°gina
document.addEventListener('visibilitychange', function() {
if (document.hidden) {
if (carouselInterval) {
clearInterval(carouselInterval);
}
} else {
const images = document.querySelectorAll('.carousel-image');
if (images.length > 1) {
startCarousel(images.length);
}
}
});
</script>
</body>
</html>